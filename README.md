# Сессии
По сути просто строка
При аутентификации пользователю возвращается сессия на фронт, также обычно сессия хранится в Редисе для дальнейших проверок. 
## Механизмны продления
1. Absolute timeout - сессия истекает через несколько дней от логина (отмечаем в бд)
2. idle timeout - сессия истекает через N минут бездействия
Смысл в том, что можно украсть сессию.
Сессии обычно продляются при запросе. 
В редисе можно expire для сессии использовать. Сессии обычно храним в куках ( в локал сторадж опасно так как js имеет доступ к нему)
Отззыв сессии - одно из преимуществ над JWT.
Сессия приходит в set-cookie с http_only = True. (Посмотреть куки можно в Application/Cookies)

Для выхода можно просто куки затереть. 
Сессию нужно хешировать для базы данных а сессию в сыром виде отправляем на фронт, потому что если мы украли бд мы из хэшей не можем восстановить сессии, потому что хэши односторонние функции. 
Куки ставит бекендер в респонсе. 
Сессии используются в банковских приложениях, чтобы можно было удалить быстро сессиию. В гитхабе используются сессии
# Token-based (JWT)  (jsщn web token) 
JWT хранит данные, которые можно декодировать
Состоит из header, payload( данные),signature (подпись) (разделённые через точки)
Нельзя в jwt хранить пароли логины email  другие важные данные.
Нельзя подделать токен потому что подпись генериться по данным header и signature + секретный ключ. 
## Payload
1. sub - идентификатор пользователя
2. exp = время истечения токена
   Далее необязательные данные
3. iat - время выпуска токена
4. iss - кто выдал токен (issuer) типа какая апишка
5. aud - кому предазначен audience
6. jti - уникальный id токена для отзыва (чтобы его можно было инвалидировать(
7. дальше что угодно можно хранить например можно хранить права чтобы к бд не ходить каждый раз (мегабайты данных хранить не надо)
Как раз один из минусов jwt это размер. По сети каждый раз гоняется токен это плохо

Небольшое отступление - в микросервисах не хочется давать всем секертный ключ чтобы выдавать токены, поэтому используются алгоритмы с двусторонними ключами чтобы в микросервисах очень быстро валидировать, корректный ли токен. 
Надо публичный ключ проверять.

## Флоу
В хранилище при аутентификации мы содаём refresh_token. сервер генерит access_token (JWT) и отправляет клиенту оба токена. ПРичем JWT не хранится на сервере, чтобы облегчить. 
И при запросах проверяется валдиность access_token без хранилища. 

- Access token (jwt) - короткоживущий, передаётся во всех запросах
- Refresh token - живет долго, передаётся только при обновлении токенов (когда access token закончися, чтобы новый access token получить)
В python используется jwt чтобы encode и decode данные. (при подписи нужен ключ из переменной окружения продакшена). Refresh обычно просто рандомная последовательноть.

## ПРодление
1. Acces истек (удаляется из браузера)
2. Отправляется refresh на специальный эндпоинт
3. Сервер проверяет рефреш
4. Если всё хорошо заменяем refresh на новый и старый отзываем. (если мы будем старым продлевать то если ему украдут то хакер получит вечный доступ к аукаунт)
5. Пользователю отправляются оба токена
## Инвалидация
Refresh token можно отозватьа access token нельзя, он работает до истечения времени экспирации (можно сделать через jti но это аналогично сессиям)

Оба токена лежат в куки. (JWT Можно декодировать через специальный сайт) (Только зная серкерт можно проверить токен) 
КУКИ АВТОМАТИЧЕСКИ ШЛЮТСЯ С ЗАПРОСАМИ!!. Разработчик договаривается про токены. 
Рефреш токены хэшируем разумеется.  РЕФРШ НЕЛЬЗЯ ХРАНИТЬ НИГДЕ КРОМЕ КУК

#ВЫВОДЫ
# СРАВНЕНИЕ СЕССИЙ И JWT-ТОКЕНОВ

| Критерий             | Сессии                             | JWT-токены                            |
|----------------------|------------------------------------|---------------------------------------|
| Архитектура системы  | Удобнее для монолитов              | Удобнее для микросервисов             | 
| Безопасность         | Безопасны по умолчанию             | Высокий риск ошибки в реализации      |
| Сложность реализации | Легче                              | Сложнее                               |
| Размер               | Маленький                          | Большой                               |
| Ревокация  (отзыв)   | Легко                              | Сложно                                |
| Продление            | На сервере                         | На клиенте и сервере                  |
| Валидация            | Нужно обращение в центральное хранилище | Не нужно обращение в хранилище     |
| Стандартизация       | Нет стандарта                      | Единый стандарт JWT (одни и те же поля) |







